name: Backend CI/CD (Kind + LocalStack) ğŸ³

on:
  push:
    branches: [main, develop]
    paths:
      - 'apps/backend/**'
      - '.github/workflows/backend-ci-local.yml'
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  KIND_VERSION: v0.20.0
  KUBECTL_VERSION: v1.28.0
  LOCALSTACK_VERSION: "3.0"

jobs:
  test-local:
    name: Test con Kind + LocalStack
    runs-on: ubuntu-latest
    
    services:
      localstack:
        image: localstack/localstack:3.0
        env:
          SERVICES: s3,secretsmanager
          DEBUG: "1"
          DATA_DIR: /tmp/localstack/data
          DOCKER_HOST: unix:///var/run/docker.sock
        ports:
          - 4566:4566
        options: >-
          --health-cmd="curl -f http://localhost:4566/_localstack/health || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ³ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: â˜¸ï¸ Install Kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
          kind version
      
      - name: ğŸ”§ Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/${{ env.KUBECTL_VERSION }}/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
          kubectl version --client
      
      - name: ğŸ“¦ Install AWS CLI Local
        run: |
          pip install awscli-local[ver1]
          awslocal --version
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # LOCALSTACK INIT
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      - name: ğŸ”Œ Wait for LocalStack
        run: |
          echo "â³ Waiting for LocalStack to be ready..."
          timeout 60 bash -c 'until curl -s http://localhost:4566/_localstack/health | grep "\"s3\": \"available\""; do sleep 2; done'
          echo "âœ… LocalStack is ready!"
      
      - name: ğŸª£ Create S3 Bucket in LocalStack
        run: |
          awslocal s3 mb s3://gpuchile-dev || echo "Bucket already exists"
          awslocal s3 ls
          echo "âœ… S3 bucket 'gpuchile-dev' is ready"
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # KIND CLUSTER SETUP (ğŸ”¥ CORRECCIÃ“N APLICADA)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      - name: â˜¸ï¸ Create Kind Cluster
        run: |
          cat <<EOF | kind create cluster --name gpuchile-ci --config=-
          kind: Cluster
          apiVersion: kind.x-k8s.io/v1alpha4
          nodes:
          - role: control-plane
            extraPortMappings:
            - containerPort: 30000
              hostPort: 8000
              protocol: TCP
          networking:
            apiServerAddress: "0.0.0.0"
            apiServerPort: 6443
          EOF
          
          echo "âœ… Kind cluster created"
      
      - name: ğŸ”§ Configure kubectl for Kind
        run: |
          # Crear directorio .kube si no existe
          mkdir -p $HOME/.kube
          
          # Exportar kubeconfig
          kind export kubeconfig --name gpuchile-ci --kubeconfig $HOME/.kube/config
          
          # Set KUBECONFIG para pasos siguientes
          echo "KUBECONFIG=$HOME/.kube/config" >> $GITHUB_ENV
          
          # Verificar conectividad
          echo "===== Cluster Info ====="
          kubectl cluster-info --context kind-gpuchile-ci
          
          echo "===== Nodes ====="
          kubectl get nodes -o wide
          
          # Wait for control plane
          echo "â³ Waiting for nodes to be ready..."
          kubectl wait --for=condition=Ready nodes --all --timeout=60s
          
          echo "âœ… kubectl configured successfully!"
      
      - name: ğŸŒ Configure Docker Network
        run: |
          # Obtener contenedores
          KIND_CONTAINER=$(docker ps -qf "name=gpuchile-ci-control-plane")
          LOCALSTACK_CONTAINER=$(docker ps -qf "ancestor=localstack/localstack:3.0")
          
          echo "Kind Container: $KIND_CONTAINER"
          echo "LocalStack Container: $LOCALSTACK_CONTAINER"
          
          # Obtener IP de LocalStack
          LOCALSTACK_IP=$(docker inspect -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' $LOCALSTACK_CONTAINER | head -n1)
          echo "LocalStack IP: $LOCALSTACK_IP"
          echo "LOCALSTACK_IP=$LOCALSTACK_IP" >> $GITHUB_ENV
          
          # Obtener la red de Kind
          KIND_NETWORK=$(docker inspect $KIND_CONTAINER -f '{{range $net,$v := .NetworkSettings.Networks}}{{$net}}{{end}}' | head -n1)
          echo "Kind Network: $KIND_NETWORK"
          
          # Conectar LocalStack a la red de Kind
          docker network connect $KIND_NETWORK $LOCALSTACK_CONTAINER || echo "Already connected"
          
          # Verificar conectividad desde el nodo de Kind
          echo "===== Testing connectivity from Kind node ====="
          docker exec $KIND_CONTAINER curl -s http://$LOCALSTACK_IP:4566/_localstack/health || echo "Connection test failed"
          
          echo "âœ… Network configured"
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # BUILD & LOAD IMAGE
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      - name: ğŸ—ï¸ Build Backend Image
        run: |
          cd apps/backend
          docker build -t gpuchile-backend:test .
          echo "âœ… Image built successfully"
      
      - name: ğŸ“¤ Load Image to Kind
        run: |
          kind load docker-image gpuchile-backend:test --name gpuchile-ci
          echo "âœ… Image loaded into Kind cluster"
          
          # Verificar que la imagen estÃ¡ en el nodo
          docker exec gpuchile-ci-control-plane crictl images | grep gpuchile-backend || echo "Image not found in node"
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # DEPLOY TO KIND
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      - name: ğŸ“‹ Create ConfigMap for LocalStack
        run: |
          kubectl create configmap localstack-config \
            --from-literal=LOCALSTACK_ENDPOINT=http://${{ env.LOCALSTACK_IP }}:4566 \
            --from-literal=USE_LOCALSTACK=true \
            --from-literal=AWS_REGION=us-east-1 \
            --from-literal=S3_BUCKET_NAME=gpuchile-dev
          
          kubectl get configmap localstack-config -o yaml
      
      - name: ğŸ” Create Secrets
        run: |
          kubectl create secret generic db-credentials \
            --from-literal=DATABASE_URL=postgresql://postgres:postgres123@postgres:5432/gpuchile \
            --from-literal=SECRET_KEY=test-secret-key-for-ci
      
      - name: ğŸš€ Deploy Backend to Kind
        run: |
          cat <<EOF | kubectl apply -f -
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: gpuchile-backend
            labels:
              app: backend
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: backend
            template:
              metadata:
                labels:
                  app: backend
              spec:
                containers:
                - name: backend
                  image: gpuchile-backend:test
                  imagePullPolicy: Never
                  ports:
                  - containerPort: 8000
                  env:
                  - name: USE_LOCALSTACK
                    valueFrom:
                      configMapKeyRef:
                        name: localstack-config
                        key: USE_LOCALSTACK
                  - name: LOCALSTACK_ENDPOINT
                    valueFrom:
                      configMapKeyRef:
                        name: localstack-config
                        key: LOCALSTACK_ENDPOINT
                  - name: AWS_REGION
                    valueFrom:
                      configMapKeyRef:
                        name: localstack-config
                        key: AWS_REGION
                  - name: S3_BUCKET_NAME
                    valueFrom:
                      configMapKeyRef:
                        name: localstack-config
                        key: S3_BUCKET_NAME
                  - name: DATABASE_URL
                    valueFrom:
                      secretKeyRef:
                        name: db-credentials
                        key: DATABASE_URL
                  - name: SECRET_KEY
                    valueFrom:
                      secretKeyRef:
                        name: db-credentials
                        key: SECRET_KEY
                  resources:
                    limits:
                      cpu: "500m"
                      memory: "512Mi"
                    requests:
                      cpu: "250m"
                      memory: "256Mi"
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: backend-service
          spec:
            type: NodePort
            selector:
              app: backend
            ports:
            - port: 8000
              targetPort: 8000
              nodePort: 30000
          EOF
          
          echo "âœ… Manifests applied"
      
      - name: â³ Wait for Deployment
        run: |
          echo "â³ Waiting for deployment to be ready..."
          kubectl wait --for=condition=available --timeout=180s deployment/gpuchile-backend
          
          echo "===== Pods Status ====="
          kubectl get pods -o wide
          
          echo "===== Service Status ====="
          kubectl get svc backend-service
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # TESTS
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      - name: ğŸ§ª Run Integration Tests
        run: |
          # Port forward en background
          kubectl port-forward service/backend-service 8000:8000 &
          PF_PID=$!
          
          # Esperar a que el port forward estÃ© listo
          sleep 10
          
          # Health check
          echo "Testing /health endpoint..."
          curl -f http://localhost:8000/health || exit 1
          
          echo "âœ… Backend is healthy!"
          
          # Kill port forward
          kill $PF_PID || true
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # LOGS & CLEANUP
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      - name: ğŸ“Š Show Logs on Failure
        if: failure()
        run: |
          echo "===== BACKEND PODS ====="
          kubectl get pods
          
          echo "===== BACKEND LOGS ====="
          kubectl logs -l app=backend --tail=100 || echo "No logs available"
          
          echo "===== BACKEND POD DESCRIBE ====="
          kubectl describe pods -l app=backend || echo "No pods to describe"
          
          echo "===== LOCALSTACK LOGS ====="
          docker logs $(docker ps -qf "ancestor=localstack/localstack:3.0") --tail=100 || echo "No LocalStack logs"
          
          echo "===== KIND CLUSTER INFO ====="
          kubectl cluster-info dump || echo "Failed to dump cluster info"
      
      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up..."
          kind delete cluster --name gpuchile-ci || true
          echo "âœ… Cleanup complete"
