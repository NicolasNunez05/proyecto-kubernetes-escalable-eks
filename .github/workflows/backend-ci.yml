name: Backend CI/CD (Kind + LocalStack) ğŸ³

on:
  push:
    branches: [main, develop]
    paths:
      - 'apps/backend/**'
      - '.github/workflows/backend-ci-local.yml'
  pull_request:
    branches: [main]

# âš¡ CONFIGURACIÃ“N PARALELA
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  KIND_VERSION: v0.20.0
  KUBECTL_VERSION: v1.28.0
  LOCALSTACK_VERSION: 3.0

jobs:
  test-local:
    name: Test con Kind + LocalStack
    runs-on: ubuntu-latest
    
    services:
      # ğŸ³ LocalStack como servicio
      localstack:
        image: localstack/localstack:3.0
        env:
          SERVICES: s3,secretsmanager
          DEBUG: 1
          DATA_DIR: /tmp/localstack/data
          DOCKER_HOST: unix:///var/run/docker.sock
        ports:
          - 4566:4566
        options: >-
          --health-cmd="awslocal s3 ls || exit 1"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    
    steps:
      #â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # FASE 1: SETUP
      #â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ğŸ³ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: â˜¸ï¸ Install Kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/${{ env.KIND_VERSION }}/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind
      
      - name: ğŸ”§ Install kubectl
        run: |
          curl -LO "https://dl.k8s.io/release/${{ env.KUBECTL_VERSION }}/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/
      
      - name: ğŸ“¦ Install AWS CLI
        run: |
          pip install awscli-local[ver1]
      
      #â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # FASE 2: LOCALSTACK INIT
      #â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      
      - name: ğŸ”Œ Wait for LocalStack
        run: |
          echo "â³ Waiting for LocalStack to be ready..."
          timeout 60 bash -c 'until curl -s http://localhost:4566/_localstack/health | grep "\"s3\": \"available\""; do sleep 2; done'
          echo "âœ… LocalStack is ready!"
      
      - name: ğŸª£ Create S3 Bucket in LocalStack
        run: |
          awslocal s3 mb s3://gpuchile-dev
          awslocal s3 ls
          echo "âœ… S3 bucket created"
      
      #â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # FASE 3: KIND CLUSTER
      #â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      
      - name: â˜¸ï¸ Create Kind Cluster with Custom Network
        run: |
          # Crear cluster con configuraciÃ³n personalizada
          cat <<EOF | kind create cluster --config=-
          kind: Cluster
          apiVersion: kind.x-k8s.io/v1alpha4
          nodes:
          - role: control-plane
            extraPortMappings:
            - containerPort: 30000
              hostPort: 8000
              protocol: TCP
          networking:
            apiServerAddress: "0.0.0.0"
            apiServerPort: 6443
          EOF
          
          # Verificar
          kubectl cluster-info
          kubectl get nodes
      
      - name: ğŸŒ Configure Docker Network
        run: |
          # Obtener IP de LocalStack desde el host
          LOCALSTACK_IP=$(docker inspect -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' $(docker ps -qf "ancestor=localstack/localstack:3.0"))
          echo "LocalStack IP: $LOCALSTACK_IP"
          echo "LOCALSTACK_IP=$LOCALSTACK_IP" >> $GITHUB_ENV
          
          # Conectar Kind a la red de LocalStack
          KIND_NETWORK=$(docker network ls --filter name=kind --format '{{.Name}}')
          docker network connect $KIND_NETWORK $(docker ps -qf "ancestor=localstack/localstack:3.0") || true
      
      #â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # FASE 4: BUILD & LOAD
      #â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      
      - name: ğŸ—ï¸ Build Backend Image
        run: |
          cd apps/backend
          docker build -t gpuchile-backend:test .
      
      - name: ğŸ“¤ Load Image to Kind
        run: |
          kind load docker-image gpuchile-backend:test
          echo "âœ… Image loaded into Kind cluster"
      
      #â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # FASE 5: DEPLOY TO KIND
      #â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      
      - name: ğŸ“‹ Create ConfigMap for LocalStack
        run: |
          kubectl create configmap localstack-config \
            --from-literal=LOCALSTACK_ENDPOINT=http://${{ env.LOCALSTACK_IP }}:4566 \
            --from-literal=USE_LOCALSTACK=true \
            --from-literal=AWS_REGION=us-east-1 \
            --from-literal=S3_BUCKET_NAME=gpuchile-dev
      
      - name: ğŸ” Create Secrets
        run: |
          kubectl create secret generic db-credentials \
            --from-literal=DATABASE_URL=postgresql://postgres:postgres123@postgres:5432/gpuchile \
            --from-literal=SECRET_KEY=test-secret-key-for-ci
      
      - name: ğŸš€ Deploy Backend to Kind
        run: |
          cat <<EOF | kubectl apply -f -
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: gpuchile-backend
            labels:
              app: backend
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: backend
            template:
              metadata:
                labels:
                  app: backend
              spec:
                containers:
                - name: backend
                  image: gpuchile-backend:test
                  imagePullPolicy: Never  # ğŸ”¥ CRÃTICO para Kind
                  ports:
                  - containerPort: 8000
                  env:
                  - name: USE_LOCALSTACK
                    valueFrom:
                      configMapKeyRef:
                        name: localstack-config
                        key: USE_LOCALSTACK
                  - name: LOCALSTACK_ENDPOINT
                    valueFrom:
                      configMapKeyRef:
                        name: localstack-config
                        key: LOCALSTACK_ENDPOINT
                  - name: AWS_REGION
                    valueFrom:
                      configMapKeyRef:
                        name: localstack-config
                        key: AWS_REGION
                  - name: S3_BUCKET_NAME
                    valueFrom:
                      configMapKeyRef:
                        name: localstack-config
                        key: S3_BUCKET_NAME
                  - name: DATABASE_URL
                    valueFrom:
                      secretKeyRef:
                        name: db-credentials
                        key: DATABASE_URL
                  - name: SECRET_KEY
                    valueFrom:
                      secretKeyRef:
                        name: db-credentials
                        key: SECRET_KEY
                  resources:
                    limits:
                      cpu: "500m"
                      memory: "512Mi"
                    requests:
                      cpu: "250m"
                      memory: "256Mi"
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: backend-service
          spec:
            type: NodePort
            selector:
              app: backend
            ports:
            - port: 8000
              targetPort: 8000
              nodePort: 30000
          EOF
      
      - name: â³ Wait for Deployment
        run: |
          kubectl wait --for=condition=available --timeout=180s deployment/gpuchile-backend
          kubectl get pods
      
      #â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      # FASE 6: TESTS
      #â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      
      - name: ğŸ§ª Run Integration Tests
        run: |
          # Port forward para acceder al backend
          kubectl port-forward service/backend-service 8000:8000 &
          sleep 5
          
          # Health check
          curl -f http://localhost:8000/health || exit 1
          echo "âœ… Backend is healthy!"
          
          # Test S3 connectivity (si tienes endpoint)
          # curl -f http://localhost:8000/api/test-s3 || exit 1
      
      - name: ğŸ“Š Show Logs on Failure
        if: failure()
        run: |
          echo "===== BACKEND LOGS ====="
          kubectl logs -l app=backend --tail=100
          echo "===== LOCALSTACK LOGS ====="
          docker logs $(docker ps -qf "ancestor=localstack/localstack:3.0")
      
      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          kind delete cluster
